<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Patient Portal</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>

<h2>Patient Portal</h2>

<div id="authArea">
  <h3>Signup</h3>
  <input id="pname" placeholder="Full name">
  <input id="pemail" placeholder="Email">
  <input id="ppass" type="password" placeholder="Password">
  <button id="signupBtn">Signup</button>

  <hr>

  <h3>Login</h3>
  <input id="pemail2" placeholder="Email">
  <input id="ppass2" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
</div>

<div id="afterLogin" style="display none">
  <p>You are logged in. Scan hospital QR to get token.</p>

  <video id="video" style="width:320px;height:auto;border:1px solid #ccc"></video>
  <canvas id="canvas" style="display none"></canvas>

  <button id="scanBtn">Scan QR and get token</button>
  <button id="logoutBtn">Logout</button>
</div>

<script type="module">
  import { firebaseConfig } from "./firebase-config.js"
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"
  import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"

  const app = initializeApp(firebaseConfig)
  const auth = getAuth(app)
  const db = getFirestore(app)

  function todayString(){
    const d = new Date()
    return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0")
  }

  async function signup(){
    const name = document.getElementById("pname").value.trim()
    const email = document.getElementById("pemail").value.trim()
    const pass = document.getElementById("ppass").value
    if(!name || !email || !pass){ alert("Fill all fields"); return }
    try{
      const u = await createUserWithEmailAndPassword(auth, email, pass)
      await addDoc(collection(db, "patients"), {
        uid: u.user.uid,
        name,
        email,
        createdAt: serverTimestamp()
      })
      alert("Signup done. Login now")
    }catch(e){
      alert(e.message)
    }
  }

  async function login(){
    const email = document.getElementById("pemail2").value.trim()
    const pass = document.getElementById("ppass2").value
    if(!email || !pass){ alert("Fill login fields"); return }
    try{
      await signInWithEmailAndPassword(auth, email, pass)
      document.getElementById("authArea").style.display = "none"
      document.getElementById("afterLogin").style.display = "block"
    }catch(e){
      alert(e.message)
    }
  }

  async function logout(){
    await signOut(auth)
    document.getElementById("authArea").style.display = "block"
    document.getElementById("afterLogin").style.display = "none"
  }

  async function issueTokenFor(hospitalId){
    const user = auth.currentUser
    if(!user){ alert("Login first"); return }

    const dateStr = todayString()
    const q = query(collection(db, "tokens"), where("hospitalId","==",hospitalId), where("date","==",dateStr))
    const snap = await getDocs(q)
    const count = snap.size
    const max = 60

    if(count >= max){
      alert("All appointments full")
      return
    }

    const token = count + 1
    let slot
    if(token <= 20) slot = "09:00 to 10:00"
    else if(token <= 40) slot = "10:00 to 11:00"
    else slot = "11:00 to 12:00"

    await addDoc(collection(db, "tokens"), {
      hospitalId,
      uid: user.uid,
      tokenNumber: token,
      date: dateStr,
      slot,
      issuedAt: serverTimestamp(),
      status: "Pending"
    })

    alert("Your token is T" + token + " for slot " + slot)
  }

  async function startScan(){
    const video = document.getElementById("video")
    const canvas = document.getElementById("canvas")
    const ctx = canvas.getContext("2d")

    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      video.srcObject = stream
      video.play()

      const scanLoop = () => {
        if(video.readyState === video.HAVE_ENOUGH_DATA){
          canvas.width = video.videoWidth
          canvas.height = video.videoHeight
          ctx.drawImage(video,0,0,canvas.width,canvas.height)
          const img = ctx.getImageData(0,0,canvas.width,canvas.height)
          const code = jsQR(img.data,img.width,img.height)

          if(code){
            try{
              const data = JSON.parse(code.data)
              if(data.hospitalId){
                stream.getTracks().forEach(t => t.stop())
                issueTokenFor(data.hospitalId)
                return
              }
            }catch(e){}
          }
        }
        requestAnimationFrame(scanLoop)
      }
      scanLoop()
    }catch(e){
      alert(e.message)
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("signupBtn").addEventListener("click", signup)
    document.getElementById("loginBtn").addEventListener("click", login)
    document.getElementById("logoutBtn").addEventListener("click", logout)
    document.getElementById("scanBtn").addEventListener("click", startScan)
  })
</script>

</body>
</html>
