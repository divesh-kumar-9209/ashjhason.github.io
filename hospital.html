<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hospital Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { collection, addDoc, query, where, getDocs, onSnapshot, orderBy, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    window.hospLogin = async () => {
      const email = document.getElementById("hemail").value.trim();
      const pwd = document.getElementById("hpass").value;
      if(!email || !pwd){ alert("Enter credentials"); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pwd);
        document.getElementById("hAuth").style.display = "none";
        document.getElementById("hDash").style.display = "block";
        loadDashboard();
      }catch(e){ alert("Login failed " + e.message); }
    };

    window.hospLogout = async () => {
      await signOut(auth);
      document.getElementById("hDash").style.display = "none";
      document.getElementById("hAuth").style.display = "block";
    };

    function todayString(){
      const d = new Date();
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
    }

    window.createHospitalDoc = async () => {
      // create a simple hospital record for demo
      const hid = document.getElementById("hid").value.trim();
      const name = document.getElementById("hname").value.trim();
      if(!hid || !name){ alert("Provide hospital id and name"); return; }
      await addDoc(collection(db, "hospitals"), {
        hospitalId: hid,
        name,
        createdAt: serverTimestamp(),
        maxPerDay: 60
      });
      alert("Hospital record created. Use this hospital id for QR: " + hid);
      document.getElementById("qrText").innerText = JSON.stringify({ hospitalId: hid });
      // generate QR visually is handled by client using qrcode lib loaded below
    };

    async function loadDashboard(){
      const dateStr = todayString();
      const q = query(collection(db,"tokens"), where("date","==",dateStr), orderBy("issuedAt"));
      onSnapshot(q, snapshot => {
        const list = document.getElementById("tokenList");
        list.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const li = document.createElement("div");
          li.innerHTML = "T" + data.tokenNumber + " | " + (data.uid || "") + " | " + data.slot + " | " + data.status + " ";
          const btn = document.createElement("button");
          btn.innerText = "Call";
          btn.onclick = async () => {
            // mark as called or checked if desired
            await updateDoc(doc(db,"tokens", docSnap.id), { status: "Called" });
          };
          li.appendChild(btn);
          list.appendChild(li);
        });
      });
    }

    window.loadQRlib = () => {
      // leave placeholder, qrcode lib is included by script tag below
    };

    window.onload = loadQRlib;
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h2>Hospital Login</h2>
  <div id="hAuth">
    <input id="hemail" placeholder="Hospital admin email">
    <input id="hpass" placeholder="Password" type="password">
    <button onclick="hospLogin()">Login</button>
  </div>

  <div id="hDash" style="display:none">
    <h3>Dashboard</h3>
    <p>Create hospital record and QR</p>
    <input id="hid" placeholder="hospital id e.g. HOSP1">
    <input id="hname" placeholder="Hospital name">
    <button onclick="createHospitalDoc()">Create Hospital and Show QR text</button>

    <div id="qrArea">
      <p id="qrText"></p>
      <div id="qrbox"></div>
      <script>
        // generate QR when qrText changes by observing periodically
        setInterval(() => {
          const txt = document.getElementById("qrText").innerText;
          const box = document.getElementById("qrbox");
          if(txt && box.innerHTML.trim()===""){
            new QRCode(box, { text: txt, width: 160, height: 160 });
          }
        }, 800);
      </script>
    </div>

    <h4>Today's issued tokens</h4>
    <div id="tokenList"></div>

    <button onclick="hospLogout()">Logout</button>
  </div>
</body>
</html>
