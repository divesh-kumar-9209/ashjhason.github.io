<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Hospital Dashboard</title>

  <link rel="stylesheet" href="./style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

<h2 class="center">Hospital Dashboard</h2>

<div id="authArea" class="card-box">
  <h3>Hospital admin login</h3>
  <input id="hemail" placeholder="Admin email">
  <input id="hpass" placeholder="Password" type="password">
  <button id="loginBtn">Login</button>
</div>

<div id="dashArea" style="display:none">

  <div class="card-box">
    <h3>Hospital info and QR code</h3>
    <input id="hid" placeholder="Hospital ID example Lucknow_Hospital">
    <input id="hname" placeholder="Hospital name">
    <input id="hmax" placeholder="Max tokens per day example 60">

    <button id="saveHospitalBtn">Create or update hospital</button>

    <div style="margin-top:16px; display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start">
      <div>
        <div id="qrbox"></div>
        <button id="downloadQrBtn" style="margin-top:8px">Download QR image</button>
      </div>
      <div>
        <div>QR payload</div>
        <pre id="qrText" style="background:#f4f8fb;border-radius:8px;padding:8px 10px;margin-top:6px;"></pre>
        <p style="font-size:13px;color:#4c6b70;margin-top:6px;max-width:260px">
          Print this QR and place it at the hospital counter. Patients will scan this code from the patient portal.
        </p>
      </div>
    </div>

    <div style="margin-top:14px">
      <button id="refreshTokensBtn">Refresh todays tokens</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="card-box">
    <h3>Today issued tokens</h3>
    <div id="tokenList"></div>
  </div>
</div>

<script>
  var firebaseConfig = {
    apiKey: "AIzaSyAJnlrtazUWr_HjQiEkFNcbnsve73g1pEQ",
    authDomain: "smart-opd-69488.firebaseapp.com",
    projectId: "smart-opd-69488",
    storageBucket: "smart-opd-69488.firebasestorage.app",
    messagingSenderId: "373276983810",
    appId: "1:373276983810:web:88a3018ab7b811550d1d1b"
  }
  firebase.initializeApp(firebaseConfig)
  var auth = firebase.auth()
  var db = firebase.firestore()

  var currentHospitalId = null

  function todayString(){
    var d = new Date()
    return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0")
  }

  function renderTokens(list, maxPerDay){
    var box = document.getElementById("tokenList")
    box.innerHTML = ""
    if(!list || list.length === 0){
      box.innerHTML = "<div style='color:#4c6b70'>No tokens for today yet</div>"
      return
    }
    list.forEach(function(t){
      var div = document.createElement("div")
      div.className = "tokenCard"

      var top = document.createElement("div")
      top.innerHTML = "<strong>Token " + t.tokenNumber + "</strong> visiting window " + (t.slot || "") + " status " + (t.status || "Pending")
      var sub = document.createElement("div")
      sub.style.fontSize = "13px"
      sub.style.marginTop = "4px"
      sub.innerText = "Date " + (t.date || todayString()) + " patient " + (t.uid || "")

      var btnCall = document.createElement("button")
      btnCall.innerText = "Call"
      btnCall.onclick = function(){
        db.collection("tokens").doc(t._id).update({ status:"Called" })
      }

      var btnCheck = document.createElement("button")
      btnCheck.innerText = "Checked in"
      btnCheck.onclick = function(){
        db.collection("tokens").doc(t._id).update({ status:"Checked In" })
      }

      var btnDel = document.createElement("button")
      btnDel.innerText = "Delete"
      btnDel.onclick = function(){
        if(confirm("Delete this token")) db.collection("tokens").doc(t._id).delete()
      }

      div.appendChild(top)
      div.appendChild(sub)
      div.appendChild(btnCall)
      div.appendChild(btnCheck)
      div.appendChild(btnDel)

      box.appendChild(div)
    })
  }

  function loadTodayTokens(hid){
    if(!hid) return
    var dateStr = todayString()
    db.collection("tokens")
      .where("hospitalId","==",hid)
      .where("date","==",dateStr)
      .get()
      .then(function(snap){
        var arr = []
        snap.forEach(function(doc){
          var d = doc.data()
          d._id = doc.id
          arr.push(d)
        })
        arr.sort(function(a,b){
          var ta = a.issuedAt && a.issuedAt.toMillis ? a.issuedAt.toMillis() : 0
          var tb = b.issuedAt && b.issuedAt.toMillis ? b.issuedAt.toMillis() : 0
          return ta - tb
        })

        var maxPerDay = 60
        db.collection("hospitals").where("hospitalId","==",hid).get().then(function(hsnap){
          if(!hsnap.empty){
            var hd = hsnap.docs[0].data()
            if(hd.maxPerDay) maxPerDay = hd.maxPerDay
          }
          renderTokens(arr, maxPerDay)
        }).catch(function(){
          renderTokens(arr, maxPerDay)
        })
      })
      .catch(function(err){
        alert("Error loading tokens " + err.message)
      })
  }

  function generateQrForHospital(hid){
    if(!hid) return
    currentHospitalId = hid
    var payload = JSON.stringify({ hospitalId: hid })
    var qt = document.getElementById("qrText")
    qt.textContent = payload
    var box = document.getElementById("qrbox")
    box.innerHTML = ""
    new QRCode(box, {
      text: payload,
      width: 260,
      height: 260
    })
  }

  function downloadQrImage(){
    var box = document.getElementById("qrbox")
    var img = box.querySelector("img") || box.querySelector("canvas")
    if(!img){
      alert("QR not ready yet")
      return
    }
    var href
    if(img.tagName === "IMG"){
      href = img.src
    }else{
      href = img.toDataURL("image/png")
    }
    var a = document.createElement("a")
    a.href = href
    var name = currentHospitalId ? currentHospitalId + "_QR.png" : "hospital_qr.png"
    a.download = name
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
  }

  document.getElementById("loginBtn").onclick = function(){
    var email = document.getElementById("hemail").value.trim()
    var pass = document.getElementById("hpass").value
    if(!email || !pass) return
    auth.signInWithEmailAndPassword(email, pass).catch(function(e){ alert(e.message) })
  }

  document.getElementById("logoutBtn").onclick = function(){
    auth.signOut()
  }

  document.getElementById("saveHospitalBtn").onclick = function(){
    var hid = document.getElementById("hid").value.trim()
    var name = document.getElementById("hname").value.trim()
    var max = parseInt(document.getElementById("hmax").value || "60",10)
    if(!hid || !name){
      alert("Fill hospital id and name")
      return
    }
    db.collection("hospitals").where("hospitalId","==",hid).get()
      .then(function(snap){
        if(snap.empty){
          return db.collection("hospitals").add({
            hospitalId:hid,
            name:name,
            maxPerDay:max
          })
        }else{
          var id = snap.docs[0].id
          return db.collection("hospitals").doc(id).update({
            name:name,
            maxPerDay:max
          })
        }
      })
      .then(function(){
        generateQrForHospital(hid)
        loadTodayTokens(hid)
      })
      .catch(function(e){ alert(e.message) })
  }

  document.getElementById("refreshTokensBtn").onclick = function(){
    if(!currentHospitalId){
      var txt = document.getElementById("qrText").textContent
      if(txt){
        try{
          var obj = JSON.parse(txt)
          currentHospitalId = obj.hospitalId
        }catch(e){}
      }
    }
    if(!currentHospitalId){
      alert("Set hospital and QR first")
      return
    }
    loadTodayTokens(currentHospitalId)
  }

  document.getElementById("downloadQrBtn").onclick = downloadQrImage

  auth.onAuthStateChanged(function(user){
    var authBox = document.getElementById("authArea")
    var dash = document.getElementById("dashArea")
    if(user){
      authBox.style.display = "none"
      dash.style.display = "block"
    }else{
      authBox.style.display = "block"
      dash.style.display = "none"
    }
  })
</script>

</body>
</html>
